<!DOCTYPE html>
<canvas id="screen" width="640" height="640"></canvas>
<style>
 #screen { background-color : white; }
</style>
<script type="text/javascript">

//グローバル変数
//画面に描画するための変数もろもろ
var context = document.getElementById("screen");
var draw = context.getContext("2d");
var t = Date.now(); //再描画の時間を測定
var t_old=0;  //再描画のための変数
//マップ
var MX = 20;  //マップX座標最大値
var MY = 20;  //マップY座標最大値
var map = []; //マップデータを格納する変数宣言
//画像ファイル格納用
var images = [];

var x=0;
var y=10;
var vx=1;
var vy=1;
var c = 13;

//requestAnimatinFrameのブラウザ違いを吸収
//(function() {
//  var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame ||
//                              window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
//  window.requestAnimationFrame = requestAnimationFrame;
//})();

//requestAnimationFrame非対応環境用
(function(win){
    var timer = null, polyfill;
    polyfill = function(callback){
        clearTimeout(timer);
        setTimeout(callback, 1000 / 60);
    };
    win.requestAnimationFrame = win.requestAnimationFrame
    || win.mozRequestAnimationFrame
    || win.webkitRequestAnimationFrame
    || polyfill;
}(window));

//ここからプログラム開始
window.onload = init();

//初期化
function init(){

  //マップ初期化
  initMap();

  //画像ファイル読み込み
  var files = ["field.png", "road.png", "dungeon.png", "tree.png", "water.png", "rock.png", "brick.png", "treasure.png", "key.png", "down.png", "up.png", "master.png", "wizard.png", "knight01.png", "knight02.png"];
  var index=0;
  for (var i in files ) {
    var img = new Image();
    img.src = files[i];
    images[i] = img; //画像を配列に格納
	
	//全ての画像ファイルを読み込み完了したら、描画を開始
    img.onload = function(){
      index++;
	  if ( index == files.length ) {
	    drawScreen();
	  }
    };
	//もし、読み込みに失敗したら警告を表示
    img.onerror = function(){
      alert("画像読み込み失敗");
    };
  }
}

//画面描画
function drawScreen(){
  
  //経過時間をはかる
  //IE8以前ならDate.now()が対応していないため回避
  if (Date.now === undefined) {
    Date.now = function(){
	  return new Date().valueOf();
	};
  } 
  
  var t = Date.now();
  
  //30ミリ秒経過していたら描画
  if ( t - t_old > 30) {
    t_old = t;  //現在時刻を格納
	
	//画面消去
    draw.clearRect(0,0,640,640);
	
	//マップ描画
	drawMap();
	
	//キャラクター描画
	drawChar(x,y);
	
    //キャラクター移動
	moveChar();
	
  }
  
  //ブラウザのタイミングで再描画を呼び出し
  requestAnimationFrame(drawScreen);
}

//マップ描画
function drawMap(){
  for( var y = 0; y < MY; y++){
    for( var x = 0; x < MX; x++){
	  var index = map[y][x];
	  draw.drawImage( images[index], x*32, y*32);
	}
  }
}

//キャラクター描画
function drawChar(x,y){
  draw.drawImage(images[c], x, y);
}

//キャラクター移動
function moveChar(){
  x=x+2*vx;
  y=y+2*vy;
  if ( x > 640 ) { vx=-1 };
  if ( x < 0   ) { vx= 1 };
  if ( y > 640 ) { vy=-1 };
  if ( y < 0   ) { vy= 1 };
  c=c+1;
  if ( c > 14   ) { c = 13 };
}

//マップデータ初期化
function initMap(){
  //MAP1　地上フィールド
  map = 
  [  
    [ 3,3,3,3,3,6,6,6,4,3,3,3,3,3,3,3,3,3,3,3 ],
    [ 3,1,1,0,0,6,11,6,4,3,3,0,0,0,0,0,0,0,0,3 ],
    [ 3,1,1,0,0,0,0,0,4,3,3,0,3,3,3,3,3,3,0,3 ],
    [ 3,1,1,0,0,0,0,0,4,4,3,0,0,0,3,0,0,0,0,3 ],
    [ 3,1,1,0,0,4,1,4,4,4,3,3,3,0,3,3,0,3,3,3 ],
    [ 3,3,1,1,0,0,1,1,1,4,4,3,3,0,0,3,0,0,3,3 ],
    [ 3,3,1,1,3,0,4,3,1,4,4,4,3,7,0,3,3,0,0,3 ],
    [ 3,3,0,1,0,0,0,4,1,1,3,4,3,3,3,3,3,3,0,3 ],
    [ 3,0,0,1,0,0,0,4,3,1,3,4,0,3,3,3,3,3,0,3 ],
    [ 3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3 ],
    [ 3,3,3,0,3,3,4,4,4,4,4,4,4,4,1,1,1,1,1,3 ],
    [ 3,0,0,0,0,0,0,0,4,4,4,4,4,4,4,4,4,4,1,5 ],
    [ 3,3,0,0,0,0,0,0,0,4,4,5,5,5,5,5,5,4,1,5 ],
    [ 3,3,3,3,3,3,3,3,0,4,4,5,5,5,5,5,5,5,1,5 ],
    [ 3,0,5,5,5,5,5,3,0,4,5,5,1,1,1,1,1,5,1,5 ],
    [ 3,5,5,1,1,1,5,5,0,4,5,5,1,5,5,5,1,5,1,5 ],
    [ 3,5,1,1,1,1,1,5,1,4,5,5,1,5,12,1,1,5,1,5 ],
    [ 3,5,1,5,5,5,1,1,1,4,5,5,1,5,5,5,5,5,1,5 ],
    [ 3,5,8,5,5,5,5,5,4,5,5,5,1,1,1,1,1,1,1,5 ],
    [ 3,5,5,5,5,3,3,3,4,5,5,5,5,5,5,5,5,5,5,5 ]
  ];
}

</script>
